services:
  n8n:
    image: n8nio/n8n:1.22.1
    environment:
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-admin}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: infra-postgres
      DB_POSTGRESDB_DATABASE: n8n_db
      DB_POSTGRESDB_USER: n8n_app
      DB_POSTGRESDB_PASSWORD: ${N8N_DB_PASSWORD}
      N8N_HOST: n8n.localhost
      N8N_PORT: 5678
      N8N_PROTOCOL: https
      WEBHOOK_URL: https://n8n.localhost/
      EXECUTIONS_MODE: regular
      EXECUTIONS_TIMEOUT: 3600
      EXECUTIONS_TIMEOUT_MAX: 7200
      N8N_REDIS_HOST: infra-redis
      N8N_REDIS_PORT: 6379
    volumes:
      - type: bind
        source: /srv/docker/volumes/n8n/.n8n
        target: /home/node/.n8n
      - type: bind
        source: ./configs/n8n/config.json
        target: /home/node/.n8n/config
    networks:
      - backend-internal
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.localhost`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certResolver=mkcert"
      - "traefik.http.routers.n8n.middlewares=security-headers@file,rate-limit@file"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      - "traefik.http.services.n8n.loadbalancer.healthcheck.path=/healthz"
      - "traefik.http.services.n8n.loadbalancer.healthcheck.interval=10s"
    depends_on:
      infra-postgres:
        condition: service_healthy
      infra-redis:
        condition: service_healthy

networks:
  backend-internal:
    external: true
  traefik-public:
    external: true